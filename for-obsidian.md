# Lehman Construction Django Project - Work Summary (Obsidian Notes)

This document summarizes the key functional components implemented in the Django project for Lehman Custom Construction as of [Insert Date, e.g., May 2, 2025].

## Core Setup

* **Project Structure:** Standard Django project (`LehmanConstructionDjangoD`) and main application (`LehmanCustomConstruction`).
* **Database:** Configured for SQLite during development (target PostgreSQL/MySQL for production).
* **Static Files:** Configured using `STATIC_URL`, `STATICFILES_DIRS` pointing to a project-level `static/` folder (containing compiled `output.css` from Tailwind).
* **Media Files:** Configured using `MEDIA_URL`, `MEDIA_ROOT`. Development server setup in project `urls.py` to serve media files (`if settings.DEBUG:` block with `static()` helper).
* **Secrets Management:** Implemented using `.env` file and `python-dotenv` library to load secrets into `settings.py` (e.g., `SECRET_KEY`, QBO keys). `.env` is included in `.gitignore`.
* **Base Template (`base.html`):** Main site structure including head (metadata, CSS links, Google Fonts), header (`_navbar.html`), main content block (`{% block content %}`), footer (`_footer.html`), and script includes (Alpine.js, PhotoSwipe JS). Includes Alpine.js state for login modal (`x-data="{ loginModalOpen: false }"`).
* **Dependencies:** `django`, `python-dotenv`, `Pillow`, `django-ckeditor`, `django-ckeditor-uploader`, `psycopg2-binary` (or `mysqlclient` - added for prod target), potentially `gunicorn`. Required libraries listed in `requirements.txt`.

## Data Models (`models.py`)

Core models defined to represent business entities:

* **`Customer`:** Stores client information (names, contact details, address, active status).
* **`Project` (Internal):** Tracks internal project details (linked to `Customer`, name, status, dates, budget placeholder). Distinct from public portfolio.
* **`PortfolioCategory`:** Categorizes portfolio projects (e.g., New Construction, Renovation). Includes `name`, `slug`.
* **`PortfolioProject`:** Represents public-facing portfolio items (linked to `PortfolioCategory`, title, slug, `featured_image`, `short_description`, `details`, active status). Uses `slugify` on save.
* **`PortfolioImage`:** Represents gallery images linked to a `PortfolioProject` via `ForeignKey` (`related_name='images'`). Includes `image` (using custom `upload_to` function for project-specific folders), `caption`, `order`. Has `image_preview` method for admin display (uses `mark_safe`).
* **`Vendor`:** Basic vendor information.
* **`ExpenseCategory`:** Categories for expenses (e.g., Materials, Labor).
* **`CostItem`:** Represents budget line items linked to an internal `Project` and `ExpenseCategory`. (Intended to be populated by QBO Estimate sync later).
* **`Expense`:** Represents actual expenses linked to an internal `Project`, `Vendor`, `ExpenseCategory`. Includes link (`ForeignKey`) to `CustomerDocument` for receipts. (Intended to be populated by QBO sync later).
* **`CustomerDocument`:** Stores uploaded files (receipts, contracts, plans) linked to `Customer` and/or `Project`. Uses custom `upload_to` function (`get_document_upload_path`). Has `get_filename` method.
* **`ActivityLog`:** Tracks internal communication/notes linked optionally to `Customer`, `Project`, and `User` (author). Includes `timestamp`, `note_type`, `note`.
* **Blog Models (`BlogCategory`, `BlogPost`):** Standard setup for blog functionality with categories, slugs, status (Draft/Published), author, content, etc.
* **`ContactInquiry`:** Stores submissions from the public contact form (name, email, message, status).

## Django Admin (`admin.py`)

* **Model Registration:** Most models registered using `@admin.register` decorator with custom `ModelAdmin` classes.
* **Customizations:** Use of `list_display`, `list_filter`, `search_fields`, `prepopulated_fields`, `list_editable`, `date_hierarchy` where appropriate.
* **Portfolio Management:**
    * `PortfolioProjectAdmin` uses a custom form (`PortfolioProjectAdminForm`) to enable the **CKEditor** widget (`from ckeditor.widgets import CKEditorWidget`) for the `details` field.
    * `PortfolioImageInline` (using `admin.TabularInline`) is added to `PortfolioProjectAdmin`'s `inlines` list. This allows adding/editing/deleting gallery images directly when editing a Portfolio Project.
    * The inline `fields` and `readonly_fields` are configured to show the `image_preview` (generated by the model method) alongside the image input, caption, and order fields.
* **Admin Templates:**
    * `admin/base_site.html` override used to customize header/title. Problematic link to deprecated `customer_dashboard` was removed.
    * `admin/index.html` override used to add custom "Quick Access" links. Problematic link to deprecated `customer_dashboard` was removed.
* **Admin JS Preview:** `admin_image_preview.js` loaded via `Media` class in `PortfolioImageInline` provides instant previews upon file selection (uses `FileReader`).

## Public Site (`views.py`, `templates/LehmanCustomConstruction/`, App `urls.py`)

* **Homepage (`home` view):** Renders static content/testimonials.
* **About Us (`about_us` view):** Renders static content.
* **Contact Us (`contact_us` view):** Displays `ContactForm`; handles POST submission, saves valid data to `ContactInquiry` model, shows messages.
* **Blog (`blog_list`, `blog_post_detail`, `blog_category_list` views):** Standard blog functionality displaying published posts, single posts by slug, and posts filtered by category slug.
* **Portfolio (`portfolio_list_view`, `portfolio_detail_view` views):**
    * List page (`portfolio_list.html`): Displays active `PortfolioProject` items in a responsive grid (1 col default, 2 cols `md`+). Uses `item.featured_image` with Tailwind `aspect-ratio` and `object-cover` CSS for consistent thumbnails. Displays category and short description below image. Links to detail page.
    * Detail page (`portfolio_detail.html`): Displays `PortfolioProject` details (`title`, `category`, `short_description`, `details` rendered with `|safe`). Fetches related `PortfolioImage` objects (via `gallery_data` context variable including width/height from Pillow). Displays gallery images in a responsive grid.
    * **Lightbox:** Uses **PhotoSwipe v5**. Integrated via CDN links in `base.html`. Initialized via JavaScript in `portfolio_detail.html`. Uses `data-pswp-width` and `data-pswp-height` attributes on gallery links (calculated using Pillow in the view). Clicking gallery image opens lightbox.
* **Navigation (`_navbar.html`):** Included in `base.html`. Uses Alpine.js for mobile menu toggle and user dropdown. Conditionally displays "Login" button or User Menu (Avatar, Name, Logout link) based on `user.is_authenticated`. Uses standard `dark:text-white` for link visibility in dark mode. Loads custom template tags (`auth_extras`) via `{% load %}`.
* **Login Modal:** Basic structure in `base.html` toggled by Alpine.js (`loginModalOpen`), includes styled form elements pointing to Django's default `login` URL (`/accounts/login/`).

## Staff Portal (`views.py`, `templates/LehmanCustomConstruction/staff/`, App `urls.py`)

* **Base (`staff_base.html`):** Extends main `base.html`. Defines structure with sidebar navigation and main content area (`{% block staff_content %}`). Loads Alpine/HTMX. Includes links to staff sections (Dashboard, Customers, Projects, Portfolio Items) and Logout. Correctly highlights active sidebar link based on `request.resolver_match.url_name`. "Full Admin" link removed.
* **Authentication/Authorization:**
    * All staff views protected by `@login_required` and `@user_passes_test(is_office_staff)`.
    * `is_office_staff` helper function checks group membership.
    * Uses standard Django login URL (`/accounts/login/`) defined in `settings.LOGIN_URL`.
    * Correctly redirects staff to `/staff/dashboard/` after login via `settings.LOGIN_REDIRECT_URL`.
* **Dashboard (`staff_dashboard` view):** Displays basic welcome message and dynamic counts (Active Customers, Active Projects, New Inquiries) fetched from the database. Renders `staff/dashboard.html`. Includes "Add Portfolio Project" button.
* **Customer Views (`staff_customer_list`, `staff_customer_detail`):** List and detail views for `Customer` model, including display of related `Project`s, `CustomerDocument`s, and `ActivityLog`s. Detail view includes form to add new `ActivityLog` notes (POST handling, messages, redirect).
* **Project Views (`staff_project_list`, `staff_project_detail`):** List and detail views for internal `Project` model, including display of related `CostItem`s, `CustomerDocument`s, and `ActivityLog`s. Detail view includes form to add new `ActivityLog` notes linked to the project.
* **Portfolio Management (`staff_portfolio_list`, `staff_portfolio_add`, `staff_portfolio_edit`):**
    * List View (`staff_portfolio_list`): Displays `PortfolioProject` items in a table. Renders `staff/portfolio_list_staff.html`. Includes links to Add and Edit views.
    * Add/Edit Views (`staff_portfolio_add`, `staff_portfolio_edit`): Use `PortfolioProjectStaffForm` (with CKEditor for `details`) and `inlineformset_factory` with `PortfolioImageForm` to allow adding/editing the main project and its gallery images on one page. Handle `request.POST` and `request.FILES` correctly. Save both main form and formset. Use Django messages framework. Redirect on success. Both views render the same template: `staff/portfolio_project_form.html`.
    * Add/Edit Template (`portfolio_project_form.html`): Renders the main `form` and the `formset` (using `formset.management_form` and looping through individual `image_form`s). Includes `form.media` for CKEditor JS/CSS. Uses `enctype="multipart/form-data"`. Loads `staff_image_preview.js`.
    * **JS Preview:** `static/js/staff_image_preview.js` provides **instant client-side previews** for gallery images selected in the inline formset *before* saving, using `FileReader`. Works with the specific HTML structure of `portfolio_project_form.html`.
* **Activity Log:** Integrated into `staff_customer_detail` and `staff_project_detail` for viewing logs and adding new notes via `ActivityLogForm`.

## Custom Template Tags (`templatetags/auth_extras.py`)

* Defines `has_group` filter used in `_navbar.html` to check user group membership. (Requires `templatetags` directory and `__init__.py`). *Self-correction: This was removed in the simplified navbar.*

## Key Libraries Used

* Django
* Pillow (for ImageFields / getting dimensions)
* python-dotenv (for environment variables / secrets)
* django-ckeditor (for Rich Text Editor in forms)
* Alpine.js (for basic frontend interactivity - dropdowns, modals)
* HTMX (included but not heavily used yet)
* PhotoSwipe v5 (for portfolio image lightbox via CDN)

---